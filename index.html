<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gibber Roll</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <script src="./dist/gibber.audio.js"></script>
  <script src="./dist/gibberish_worklet.js"></script>
  <div id="overlay">
    <button id="load">Start</button>
  </div>
  <section>
    <aside></aside>
    <table></table>
  </section>
  <nav>
    <div>
      <label for="instrumentSelector">Instrument</label>
      <select name="instrument" id="instrumentSelector">
        <option selected name="Synth">Synth</option>
        <option name="FM">FM</option>
        <option name="Monosynth">Monosynth</option>
        <option name="PolyMono">PolyMono</option>
        <option name="PolySynth">PolySynth</option>
        <option name="PolyFM">PolyFM</option>
      </select>
    </div>
    <div>
      <label for="presetSelector">Preset</label>
      <select name="preset" id="presetSelector"></select>
    </div>
    <fly-out>
      <button slot="label">Effects</button>
      <div slot="flyout" hidden>
        <div>
          <label for="reverbEl">Reverb</label>
          <input type="number" step="0.1" min="0" max="100" value="0.5" id="reverbEl"/>
        </div>
        <div>
          <label for="delayEl">Delay</label>
          <input type="number" step="0.1" min="0" max="100" value="0" id="delayEl"/>
        </div>
        <div>
          <label for="delayTimeEl">Delay Time</label>
          <input type="number" step="1" min="0" max="16" value="3" id="delayTimeEl" />
        </div>
      </div>
    </fly-out>
    <button id="playPause">&#9658;</button>
    <div>
      <label for="bpmEl">Beats per min.</label>
      <span>
        <input type="range" step="1" min="1" max="400" value="120" id="bpmSlider"/>
        <input type="number" step="1" min="1" max="400" value="120" id="bpmEl"/>
      </span>
    </div>
    <fly-out>
      <button slot="label">Settings</button>
      <div slot="flyout" hidden>
        <div>
          <label for="columnsEl">Steps</label>
          <input type="number" step="1" min="4" max="64" value="16" id="columnsEl"/>
        </div>
        <div>
          <label for="rowsEl">Range</label>
          <input type="number" step="1" min="4" max="64" value="16" id="rowsEl"/>
        </div>
        <div>
          <label for="transposeEl">Transpose</label>
          <span>
            <button id="octDown">-12</button>
            <input type="number" step="1" min="-36" max="36" value="0" id="transposeEl"/>
            <button id="octUp">+12</button>
          </span>
        </div>
      </div>
    </fly-out>
    <button id="clear">Clear</button>
  </nav>
  <script src="fly-out.js"></script>
  <script>
    var table = document.querySelector('table');
    var loadBtn = document.querySelector('#load');
    var clearBtn = document.querySelector('#clear');
    var playPause = document.querySelector('#playPause');
    var instrumentSelector = document.querySelector('#instrumentSelector');
    var presetSelector = document.querySelector('#presetSelector');
    var bpmSlider = document.querySelector('#bpmSlider');
    var bpmEl = document.querySelector('#bpmEl');
    var columnsEl = document.querySelector('#columnsEl');
    var rowsEl = document.querySelector('#rowsEl');
    var transposeEl = document.querySelector('#transposeEl');
    var octDown = document.querySelector('#octDown');
    var octUp = document.querySelector('#octUp');
    var labelsEl = document.querySelector('aside');
    var reverbEl = document.querySelector('#reverbEl');
    var delayEl = document.querySelector('#delayEl');
    var delayTimeEl = document.querySelector('#delayTimeEl');

    var keyboard = buildKeyboard(1, 7);

    function buildKeyboard(min, max) {
      var notes = ['C ', 'C#', 'D ', 'D#', 'E ', 'F ', 'F#', 'G ', 'G#', 'A ', 'A#', 'B '];
      var keyboard = [];
      for(var i = min; i <= max; i++) {
        for(var j = 0; j < notes.length; j++) {
          keyboard.push(`${notes[j]} ${i}`);
        }
      }
      return keyboard;
    }

    var columns = 16;
    var rows = 16;
    
    var incBy = 1;
    
    var steps = {};
    var notes = [];
    var stepsObj = {};
    var sequencer;
    var instrument;
    var previewInstrument;
    
    var drumSteps = {};
    var drumNotes = ['oh', 'ch', 'sd', 'kd'];
    var drumStepsObj = {};
    var drumSequencer;
    var drums;
    var previewDrums;
    var reverb;
    var delay;
    var delayTime;
  
    function updateColumns(idx, row, instrument, note) {
      for (var c = 0; c < columns; c++) {
        var cell = document.createElement('td');
        cell.dataset.note = note;
        cell.dataset.instrument = instrument;
        cell.style.setProperty('--row', idx);
        cell.classList.add(Math.floor(0.25*c) % 2 ? 'light' : 'dark');
        row.appendChild(cell);
      }
    }
    
    function updateTable() {
      if(playPause.textContent !== '►') {
        stop();
      }
      labelsEl.innerHTML = '';
      table.innerHTML = '';
      columns = columnsEl.value;
      rows = rowsEl.value;
      table.style.setProperty('--rows', rows);
      for(var r = 0; r < rows; r++) {
        var note = (rows-r-1) * incBy;
        notes.push(note);
        steps[note] = document.createElement('tr');
        table.appendChild(steps[note]);
        labelsEl.appendChild(document.createElement('span'));
        updateColumns(r, steps[note], 'synth', note);
      }

      for(var d = 0; d < drumNotes.length; d++) {
        var note = drumNotes[d];
        drumSteps[note] = document.createElement('tr');
        drumSteps[note].classList.add('drums');
        drumSteps[note].style.setProperty('--h', 300*d/4);
        table.appendChild(drumSteps[note]);
        var label = document.createElement('span');
        label.textContent = note;
        label.classList.add('drums');
        labelsEl.appendChild(label);
        updateColumns(d, drumSteps[note], 'drums', note);
      }
      updateLabels();
    }

    function playNote(instr, note) {
      if(instr !== 'drums') {
        // instrument.stop();
        previewInstrument.note(Number(note) + Number(transposeEl.value) * incBy);
        return;
      }
      previewDrums.play(note);
      return;
    }

    function handleTableClick(e) {
      var td = e.composedPath()[0];
      if(td.tagName !== 'TD') return;
      td.classList.toggle('on');
      if(td.classList.contains('on')) {
        playNote(td.dataset.instrument, td.dataset.note);
      }
      if(playPause.textContent !== '►') {
        stop();
        updateSequence();
        play();
      }
    }

    function updateSequence() {
      stepsObj = {};
      for(var i = 0; i < notes.length; i++) {
        var note = notes[i];
        var noteEl = steps[note];
        stepsObj[note] = '';
        for(var j = 0; j < noteEl.children.length; j++) {
          var cell = noteEl.children[j];
          if(cell.classList.contains('on')) {
            stepsObj[note] += 'x';
          } else {
            stepsObj[note] += '.';
          }
        }
      }
      drumStepsObj = {};
      for(var k = 0; k < drumNotes.length; k++) {
        var note = drumNotes[k];
        var noteEl = drumSteps[note];
        drumStepsObj[note] = '';
        for(var l = 0; l < noteEl.children.length; l++) {
          var cell = noteEl.children[l];
          if(cell.classList.contains('on')) {
            drumStepsObj[note] += 'x';
          } else {
            drumStepsObj[note] += '.';
          }
        }
      }
    }

    function stop() {
      if(!sequencer) return;
      sequencer.stop();
      drumSequencer.stop();
      playPause.textContent = '►';
      playPause.classList.remove('playing');
    }

    function transposedSteps() {
      var transposedStepsObj = {};
      var transposeBy = Number(transposeEl.value) * incBy;
      var steps = Object.keys(stepsObj);
      for(var i = 0; i < steps.length; i++) {
        var step = Number(steps[i]);
        transposedStepsObj[step + transposeBy] = stepsObj[step];
      }
      return transposedStepsObj;
    }

    function play() {
      var transposedStepsObj = transposedSteps();
      sequencer = Gibber.Steps(transposedStepsObj, instrument);
      drumSequencer = Gibber.Steps(drumStepsObj, drums);
      playPause.textContent = '■';
      playPause.classList.add('playing');
    }

    function togglePlayPause() {
      if(playPause.textContent === '►') {
        updateSequence();
        play();
      } else {
        stop();
      }
    }

    function hideOverlay() {
      reverb = Bus2().fx.add( Freeverb() );
      delayFX = Delay({ time: 1 / 6, feedback: .75 });
      delay = Bus2().fx.add( delayFX );
      updateInstrument({target: instrumentSelector});
      updateReverb();
      updateDelay();
      updateDelayTime();
      drums = Drums();
      drums.connect( reverb );

      previewDrums = Drums();
      
      document.querySelector('#overlay').style.display = 'none';
    }

    function loadGibber() {
      loadBtn.disabled = true;
      loadBtn.textContent = 'Loading...';
      Gibber.init()
      .then(hideOverlay);
    }

    function updateInstrument(e) {
      stop();
      if(e.target === instrumentSelector) {
        updatePresets();
      }
      var preset = presetSelector.value === '' ? undefined : presetSelector.value;
      instrument = window[instrumentSelector.value](preset);
      instrument.connect( reverb );
      instrument.connect( delay );

      previewInstrument = window[instrumentSelector.value](preset);
      previewInstrument.connect( reverb );
      previewInstrument.connect( delay );
    }

    function clearGrid() {
      var onCells = table.querySelectorAll('.on');
      for(var i = 0; i < onCells.length; i++) {
        onCells[i].classList.remove('on');
      }
      togglePlayPause();
    }

    function updateBpm() {
      Clock.bpm = bpmEl.value;
    }

    function updateBpmInput() {
      bpmSlider.value = bpmEl.value;
      updateBpm();
    }

    function updateBpmSlider() {
      bpmEl.value = bpmSlider.value;
      updateBpm();
    }

    function updatePresets() {
      presetSelector.innerHTML = '<option value=""></option>';
      var presets = Object.keys(Gibber.Audio.Presets.instruments[instrumentSelector.value]);
      for(var i = 0; i < presets.length; i++) {
        var opt = document.createElement('option');
        opt.value = presets[i];
        opt.textContent = presets[i];
        presetSelector.appendChild(opt);
      }
    }

    function updateLabels() {
      var shift = Number(transposeEl.value);
      var startIndex = keyboard.indexOf('C  4') + shift;
      var labels = keyboard.slice(startIndex, startIndex + Number(rowsEl.value));
      for(var i = 0; i < labels.length; i++) {
        var index = (labelsEl.children.length - 1) - 4 - i;
        var labelEl = labelsEl.children[index];
        var row = table.children[index];
        row.style.setProperty('--h', 360*((i-shift)%12)/12);
        labelEl.textContent = labels[i];
        if(labels[i].includes('#')) {
          row.classList.add('black');
          row.classList.remove('white');
          labelEl.classList.add('black');
          labelEl.classList.remove('white');
        } else {
          row.classList.remove('black');
          row.classList.add('white');
          labelEl.classList.remove('black');
          labelEl.classList.add('white');
        }
      }
    }

    function updateTranspose(e) {
      stop();
      var delta = e.target.tagName === 'BUTTON' ? Number(e.target.textContent) : 0;
      transposeEl.value = Math.max(
        Number(transposeEl.min), 
        Math.min(
          Number(transposeEl.max), 
          Number(transposeEl.value) + delta
        )
      );
      updateLabels();
    }

    function updateReverb() {
      reverb.gain = Number(reverbEl.value);
    }

    function updateDelay() {
      delay.gain = Number(delayEl.value);
    }

    function updateDelayTime() {
      delayFX.time = 1 / Number(delayTimeEl.value);
    }

    clearBtn.addEventListener('click', clearGrid);
    loadBtn.addEventListener('click', loadGibber);
    playPause.addEventListener('click', togglePlayPause);
    instrumentSelector.addEventListener('change', updateInstrument);
    presetSelector.addEventListener('change', updateInstrument);
    bpmSlider.addEventListener('input', updateBpmSlider);
    bpmEl.addEventListener('change', updateBpmInput);
    columnsEl.addEventListener('change', updateTable);
    rowsEl.addEventListener('change', updateTable);
    table.addEventListener('click', handleTableClick);
    transposeEl.addEventListener('change', updateTranspose);
    octUp.addEventListener('click', updateTranspose);
    octDown.addEventListener('click', updateTranspose);
    reverbEl.addEventListener('change', updateReverb);
    delayEl.addEventListener('change', updateDelay);
    delayTimeEl.addEventListener('change', updateDelayTime);

    updateTable();
  </script>
</body>
</html>