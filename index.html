<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gibber Roll</title>
  <style>
    html, body {
      width: 100vw;
      height: 100vh;
      margin: 0;
      display: flex;
      flex-direction: column;
      font-family: monospace;
      --piano-width: 5rem;
    }
    section {
      display: flex;
      height: calc(100vh - 4rem);
      width: 100vw;
    }
    aside {
      width: var(--piano-width);  
      white-space: pre;
    }
    table {
      flex: 1;
      height: calc(100vh - 4rem);
      width: calc(100vw - var(--piano-width));
      width: -webkit-fill-available;
      height: -webkit-fill-available;
    }
    td {
      border: 1px solid #efefef;
      padding: 0;
    }
    aside {
      display: flex;
      flex-direction: column;
    }
    aside > span {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }
    aside > span.black {
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100%' height='100%'><rect fill='black' x='0%' y='12.5%' width='75%' height='75%'/><line x1='0%' x2='25%' y1='50%' y2='50%' stroke='black'></line></svg>");
      color: white;
    }
    aside > span.white {
      color: black;
    }

    span.white + span.white {
      border-top: 1px solid black;
    }

    aside > span.drums {
      justify-content: center;
      padding-left: 1rem;
      text-transform: uppercase;
      border-top: 1px solid black;
    }    

    aside > span:last-of-type {
      border-bottom: 1px solid black;
    }

    nav,
    nav > div {
      margin: 0;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: space-around;
    }
    nav > div > * {
      margin-left: 0.25rem;
    }
    .on {
      background: hsl(calc(var(--row) * 360deg / var(--rows)), 50% , 50%);
    }
    #overlay {
      position: absolute;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.75);
    }

    button {
      font-family: monospace;
    }

    input, button, td {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <script src="./dist/gibber.audio.js"></script>
  <script src="./dist/gibberish_worklet.js"></script>
  <div id="overlay">
    <button id="load">Start</button>
  </div>
  <section>
    <aside></aside>
    <table></table>
  </section>
  <nav>
    <button id="playPause">Play</button>
    <div>
      <label for="instrumentSelector">Instrument</label>
      <select name="instrument" id="instrumentSelector">
        <option selected name="Synth">Synth</option>
        <option name="FM">FM</option>
        <option name="Monosynth">Monosynth</option>
        <option name="PolyMono">PolyMono</option>
        <option name="PolySynth">PolySynth</option>
        <option name="PolyFM">PolyFM</option>
      </select>
    </div>
    <div>
      <label for="presetSelector">Preset</label>
      <select name="preset" id="presetSelector"></select>
    </div>
    <div>
      <input type="range" step="1" min="1" max="400" value="120" id="bpmSlider"/>
      <input type="number" step="1" min="1" max="400" value="120" id="bpmEl"/>
      <label for="bpmEl">bpm</label>
    </div>
    <div>
      <label for="columnsEl">Steps</label>
      <input type="number" step="1" min="4" max="64" value="16" id="columnsEl"/>
    </div>
    <div>
      <label for="transposeEl">Transpose</label>
      <button id="octDown">-12</button>
      <input type="number" step="1" min="-36" max="36" value="0" id="transposeEl"/>
      <button id="octUp">+12</button>
    </div>
    <div style="display: none;">
      <input type="number" step="1" min="4" max="64" value="16" id="rowsEl"/>
      <label for="rowsEl">Range</label>
    </div>
    <button id="clear">Clear</button>
  </nav>
  <script>
    var table = document.querySelector('table');
    var loadBtn = document.querySelector('#load');
    var clearBtn = document.querySelector('#clear');
    var playPause = document.querySelector('#playPause');
    var instrumentSelector = document.querySelector('#instrumentSelector');
    var presetSelector = document.querySelector('#presetSelector');
    var bpmSlider = document.querySelector('#bpmSlider');
    var bpmEl = document.querySelector('#bpmEl');
    var columnsEl = document.querySelector('#columnsEl');
    var rowsEl = document.querySelector('#rowsEl');
    var transposeEl = document.querySelector('#transposeEl');
    var octDown = document.querySelector('#octDown');
    var octUp = document.querySelector('#octUp');
    var labelsEl = document.querySelector('aside');

    var keyboard = buildKeyboard(1, 7);

    function buildKeyboard(min, max) {
      var notes = ['C ', 'C#', 'D ', 'D#', 'E ', 'F ', 'F#', 'G ', 'G#', 'A ', 'A#', 'B '];
      var keyboard = [];
      for(var i = min; i <= max; i++) {
        for(var j = 0; j < notes.length; j++) {
          keyboard.push(`${notes[j]} ${i}`);
        }
      }
      return keyboard;
    }

    var columns = 16;
    var rows = 16;
    
    var incBy = 1;
    
    var steps = {};
    var notes = [];
    var stepsObj = {};
    var sequencer;
    var instrument;
    
    var drumSteps = {};
    var drumNotes = ['oh', 'ch', 'sd', 'kd'];
    var drumStepsObj = {};
    var drumSequencer;
    var drums;
  
    function updateColumns(idx, row, instrument, note) {
      for (var c = 0; c < columns; c++) {
        var cell = document.createElement('td');
        cell.dataset.note = note;
        cell.dataset.instrument = instrument;
        cell.style.setProperty('--row', idx);
        row.appendChild(cell);
      }
    }
    
    function updateTable() {
      if(playPause.textContent !== 'Play') {
        stop();
      }
      labelsEl.innerHTML = '';
      table.innerHTML = '';
      columns = columnsEl.value;
      rows = rowsEl.value;
      table.style.setProperty('--rows', rows);
      for(var r = 0; r < rows; r++) {
        var note = (rows-r-1) * incBy;
        notes.push(note);
        steps[note] = document.createElement('tr');
        table.appendChild(steps[note]);
        labelsEl.appendChild(document.createElement('span'));
        updateColumns(r, steps[note], 'synth', note);
      }

      for(var d = 0; d < drumNotes.length; d++) {
        var note = drumNotes[d];
        drumSteps[note] = document.createElement('tr');
        table.appendChild(drumSteps[note]);
        var label = document.createElement('span');
        label.textContent = note;
        label.classList.add('drums');
        labelsEl.appendChild(label);
        updateColumns(d, drumSteps[note], 'drums', note);
      }
      updateLabels();
    }

    function playNote(instr, note) {
      if(instr !== 'drums') {
        instrument.stop();
        instrument.note(Number(note) + Number(transposeEl.value) * incBy);
        return;
      }
      drums.play(note);
      return;
    }

    function handleTableClick(e) {
      var td = e.composedPath()[0];
      if(td.tagName !== 'TD') return;
      if(playPause.textContent !== 'Play') {
        stop();
      }
      td.classList.toggle('on');
      if(td.classList.contains('on')) {
        playNote(td.dataset.instrument, td.dataset.note);
      }
    }

    function updateSequence() {
      stepsObj = {};
      for(var i = 0; i < notes.length; i++) {
        var note = notes[i];
        var noteEl = steps[note];
        stepsObj[note] = '';
        for(var j = 0; j < noteEl.children.length; j++) {
          var cell = noteEl.children[j];
          if(cell.classList.contains('on')) {
            stepsObj[note] += 'x';
          } else {
            stepsObj[note] += '.';
          }
        }
      }
      drumStepsObj = {};
      for(var k = 0; k < drumNotes.length; k++) {
        var note = drumNotes[k];
        var noteEl = drumSteps[note];
        drumStepsObj[note] = '';
        for(var l = 0; l < noteEl.children.length; l++) {
          var cell = noteEl.children[l];
          if(cell.classList.contains('on')) {
            drumStepsObj[note] += 'x';
          } else {
            drumStepsObj[note] += '.';
          }
        }
      }
    }

    function stop() {
      if(!sequencer) return;
      sequencer.stop();
      drumSequencer.stop();
      playPause.textContent = 'Play';
    }

    function transposedSteps() {
      var transposedStepsObj = {};
      var transposeBy = Number(transposeEl.value) * incBy;
      var steps = Object.keys(stepsObj);
      for(var i = 0; i < steps.length; i++) {
        var step = Number(steps[i]);
        transposedStepsObj[step + transposeBy] = stepsObj[step];
      }
      return transposedStepsObj;
    }

    function play() {
      var transposedStepsObj = transposedSteps();
      sequencer = Gibber.Steps(transposedStepsObj, instrument);
      drumSequencer = Gibber.Steps(drumStepsObj, drums);
      playPause.textContent = 'Stop';
    }

    function togglePlayPause() {
      if(playPause.textContent === 'Play') {
        updateSequence();
        play();
      } else {
        stop();
      }
    }

    function hideOverlay() {
      updateInstrument({target: instrumentSelector});
      drums = Drums();
      document.querySelector('#overlay').style.display = 'none';
    }

    function loadGibber() {
      loadBtn.disabled = true;
      loadBtn.textContent = 'Loading...';
      Gibber.init()
      .then(hideOverlay);
    }

    function updateInstrument(e) {
      stop();
      if(e.target === instrumentSelector) {
        updatePresets();
      }
      var preset = presetSelector.value === '' ? undefined : presetSelector.value;
      instrument = window[instrumentSelector.value](preset);
    }

    function clearGrid() {
      var onCells = table.querySelectorAll('.on');
      for(var i = 0; i < onCells.length; i++) {
        onCells[i].classList.remove('on');
      }
      togglePlayPause();
    }

    function updateBpm() {
      Clock.bpm = bpmEl.value;
    }

    function updateBpmInput() {
      bpmSlider.value = bpmEl.value;
      updateBpm();
    }

    function updateBpmSlider() {
      bpmEl.value = bpmSlider.value;
      updateBpm();
    }

    function updatePresets() {
      presetSelector.innerHTML = '<option value=""></option>';
      var presets = Object.keys(Gibber.Audio.Presets.instruments[instrumentSelector.value]);
      for(var i = 0; i < presets.length; i++) {
        var opt = document.createElement('option');
        opt.value = presets[i];
        opt.textContent = presets[i];
        presetSelector.appendChild(opt);
      }
    }

    function updateLabels() {
      var startIndex = keyboard.indexOf('C  4') + Number(transposeEl.value);
      var labels = keyboard.slice(startIndex, startIndex + Number(rowsEl.value));
      for(var i = 0; i < labels.length; i++) {
        var labelEl = labelsEl.children[labelsEl.children.length - 5 - i];
        labelEl.textContent = labels[i];
        if(labels[i].includes('#')) {
          labelEl.classList.add('black');
          labelEl.classList.remove('white');
        } else {
          labelEl.classList.remove('black');
          labelEl.classList.add('white');
        }
      }
    }

    function updateTranspose(e) {
      stop();
      var delta = e.target.tagName === 'BUTTON' ? Number(e.target.textContent) : 0;
      transposeEl.value = Math.max(
        Number(transposeEl.min), 
        Math.min(
          Number(transposeEl.max), 
          Number(transposeEl.value) + delta
        )
      );
      updateLabels();
    }

    clearBtn.addEventListener('click', clearGrid);
    loadBtn.addEventListener('click', loadGibber);
    playPause.addEventListener('click', togglePlayPause);
    instrumentSelector.addEventListener('change', updateInstrument);
    presetSelector.addEventListener('change', updateInstrument);
    bpmSlider.addEventListener('input', updateBpmSlider);
    bpmEl.addEventListener('change', updateBpmInput);
    columnsEl.addEventListener('change', updateTable);
    rowsEl.addEventListener('change', updateTable);
    table.addEventListener('click', handleTableClick);
    transposeEl.addEventListener('change', updateTranspose);
    octUp.addEventListener('click', updateTranspose);
    octDown.addEventListener('click', updateTranspose);

    updateTable();
  </script>
</body>
</html>